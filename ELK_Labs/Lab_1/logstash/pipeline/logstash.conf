input {
  tcp {
    port => 5000
    codec => json
  }
}

filter {
  # Parse timestamp
  date {
    match => ["timestamp", "ISO8601"]
    target => "@timestamp"
  }

  # Add calculated fields
  mutate {
    add_field => {
      "prediction_correct" => "%{[actual_label]}"
    }
  }

  # Calculate prediction accuracy flag
  if [predicted_label] == [actual_label] {
    mutate {
      replace => { "prediction_correct" => "true" }
    }
  } else {
    mutate {
      replace => { "prediction_correct" => "false" }
    }
  }

  # Convert types
  mutate {
    convert => {
      "confidence" => "float"
      "inference_time_ms" => "float"
      "prediction_correct" => "boolean"
    }
  }
}

output {
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "ml-predictions-%{+YYYY.MM.dd}"
  }
  
  stdout {
    codec => rubydebug
  }
}